<!DOCTYPE html>
<html lang="en">

<head>

    <title>Two Approaches to Concurrent Write-Safety in Django</title>

    <!-- Meta Tags Start -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="title" content="Two Approaches to Concurrent Write-Safety in Django">
    <meta name="description" content="When dealing with Django models accessed by multiple people, you want a way to make sure two requests don&#39;t perform writes at the same time.">
    <meta property="og:locale" content="en_US" />
    <meta property="og:description" content="When dealing with Django models accessed by multiple people, you want a way to make sure two requests don&#39;t perform writes at the same time.">
    <meta property="og:image" name="image" content="https://monadical.com/static/concurrent.jpg">
    <meta property="og:title" content="Two Approaches to Concurrent Write-Safety in Django">
    <meta property="og:type" content="article">
    <meta property="og:url" content=https://monadical.com/posts/Django-Concurrent-Write-Safety.html />
    <meta property="og:site_name" content="Monadical Consulting" />

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:description" content="When dealing with Django models accessed by multiple people, you want a way to make sure two requests don&#39;t perform writes at the same time.">
    <meta property="twitter:image" content="https://monadical.com/static/concurrent.jpg">
    <meta property="twitter:site" content="@MonadicalHQ">
    <meta property="twitter:title" content="Two Approaches to Concurrent Write-Safety in Django">
    <meta property="twitter:url" content=https://monadical.com/posts/Django-Concurrent-Write-Safety.html />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- Meta Tags End -->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Ubuntu" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fjalla+One" type="text/css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        type="text/css">

    <link rel="stylesheet" href="/static/bootstrap4-pleasant.min.css" type="text/css">
    <link rel="stylesheet" href="/static/core/css/base.css" type="text/css">

    <link rel="canonical" href="https://monadical.com/posts/Django-Concurrent-Write-Safety.html" />

    <link rel="apple-touch-icon" sizes="76x76" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="mask-icon" href="/static/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/atom-one-light.min.css">



    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
        </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
        </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
        integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous">
        </script>

    
<link rel="stylesheet" href="/static/core/css/index.css">
<link rel="stylesheet" href="/static/core/css/post.css">

</head>

<body>
    
    <header>
        
        

        <div id="header-container" class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                
                <a class="navbar-brand" id="monadical-brand" href="/index.html">
                    <img srcset="/static/core/img/logo@3x.png 3x,
                                 /static/core/img/logo@2x.png 2x"
                         src="/static/core/img/logo.png"
                         id="brand-img" />
                </a>
                

                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <div class="navbar-content-container">
                        <ul class="navbar-nav">
                            
                                
                                    <li class="nav-item">
                                        <a class="nav-link "
                                           href="/index.html">Home</a>
                                    </li>
                                
                            
                                
                                    <li class="nav-item">
                                        <a class="nav-link "
                                           href="/portfolio.html">Portfolio</a>
                                    </li>
                                
                            
                                
                                    <div class="nav-item dropdown">
                                        <button class="nav-link btn-link dropdown-toggle" type="button"
                                            id="dropdownservicesButton" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false">
                                            Services
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownservicesButton">
                                            
                                                <a class="dropdown-item nav-link"
                                                href="/ai-services.html">AI</a>
                                            
                                            <a class="dropdown-item nav-link"
                                                href="/services.html">Web Dev</a>
                                        </div>
                                    </div>
                                
                            
                                
                                    <li class="nav-item">
                                        <a class="nav-link "
                                           href="/about.html">About Us</a>
                                    </li>
                                
                            
                                
                                    <li class="nav-item">
                                        <a class="nav-link" target="_blank"
                                        href="https://careers.monadical.com/">Careers</a>
                                    </li>
                                
                            
                                
                                    <li class="nav-item">
                                        <a class="nav-link "
                                           href="/blog.html">Insights</a>
                                    </li>
                                
                            
                            <li class="nav-item">
                                <a class="nav-link"
                                   href="/contact-us.html">LET'S TALK</a>
                            </li>
                        </ul>

                    </div>
                </div>
            </nav>
        </div>
    </header>
    


    
    <article>
        
    <div id="post-content">
        <div class="container">
            <div class="row">
                <div class="col">
                    
                        <article class="article-content">
                            <!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black" name="apple-mobile-web-app-status-bar-style"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="&lt;center&gt;  # Two Approaches to Concurrent Write-Safety in Django  *Originally published 2016-08-03 on" name="description"/>





<base href=""/>
<title>Two Approaches to Concurrent Write-Safety in Django</title>
<link href="https://docs.monadical.com/icons/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="https://docs.monadical.com/icons/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="https://docs.monadical.com/icons/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="https://docs.monadical.com/icons/site.webmanifest" rel="manifest"/>
<link color="#b51f08" href="https://docs.monadical.com/icons/safari-pinned-tab.svg" rel="mask-icon"/>
<link href="https://docs.monadical.com/icons/favicon.ico" rel="shortcut icon"/>
<meta content="HedgeDoc - Ideas grow better together" name="apple-mobile-web-app-title"/>
<meta content="HedgeDoc - Ideas grow better together" name="application-name"/>
<meta content="#b51f08" name="msapplication-TileColor"/>
<meta content="https://docs.monadical.com/icons/browserconfig.xml" name="msapplication-config"/>
<meta content="#b51f08" name="theme-color"/>
<link href="https://docs.monadical.com/build/emojify.js/dist/css/basic/emojify.min.css" rel="stylesheet"/>
<link href="https://docs.monadical.com/build/font-pack.4362583c9249021b5028.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/2.15c517ea2148f55c8206.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/3.ec6e7d6280fcd73e729d.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/pretty-styles-pack.2fb0d01138de2df6de0a.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/pretty-styles.8aa1888af7df52aee395.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/1.1666d9d869a0532d9bce.css" rel="stylesheet"/><link href="https://docs.monadical.com/build/pretty.6b8d0fd475bd77f9c4c4.css" rel="stylesheet"/>
</head>
<body style="display:none;">
<div class="ui-infobar container-fluid unselectable hidden-print">
<small>
<span>
<span class="ui-lastchangeuser"> <i class="ui-user-icon small" data-placement="right" data-toggle="tooltip" style="background-image: url(https://docs.monadical.com/user/nick/avatar.svg);" title="nick"></i></span>
                
                 <span class="text-uppercase ui-status-lastchange"></span>
<span class="ui-lastchange text-uppercase" data-createtime="Mon May 14 2018 17:31:54 GMT+0000 (Coordinated Universal Time)" data-updatetime="Thu Feb 14 2019 00:23:25 GMT+0000 (Coordinated Universal Time)"></span>
</span>
<span class="pull-right">3894 views <a class="ui-edit" href="https://docs.monadical.com/#" title="Edit this note"><i class="fa fa-fw fa-pencil"></i></a></span>
<br/>
</small>
</div>
<div class="container markdown-body" id="doc">&lt;center&gt;

# Two Approaches to Concurrent Write-Safety in Django

*Originally published 2016-08-03 on [InvalidPatent.Wordpress.com](https://invalidpatent.wordpress.com/2016/08/03/two-approaches-to-concurrent-write-safety-in-django/).*

For a more in-depth overview, see: 
&lt;b&gt;&lt;a href="https://docs.sweeting.me/s/HJdHDKhjz"&gt;Architecting a Banking service for Real-Time Gaming at OddSlingers&lt;/a&gt;&lt;/b&gt;

&lt;/center&gt;

---

Sometimes when dealing with Django models accessed by multiple people, you want a way to make sure two requests don't perform writes at the same time.

For example, lets say you run a poker site, and you have 3 users playing a poker game together in the browser.

&lt;img class="  wp-image-341 aligncenter" src="https://invalidpatent.files.wordpress.com/2016/08/poker_game.png" alt="poker_game" width="562" height="449" /&gt;

You want only one active player to be able to perform game actions, and you want only one action accepted at a time.  Imagine the catastrophe if your active player could open the game in 2 tabs, fold his hand in one, and bet in the other simultaneously!&lt;!--more--&gt;

Here are two easy solutions to create concurrent-write-safe code (to prevent your hypothetical poker site from losing millions of dollars to devious 2-tab players):
&lt;ul&gt;
	&lt;li&gt;atomic database transactions, using either version numbers or timestamps to check that the version you're writing is the same as the version on disk before committing a transaction (aka &lt;a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control"&gt;Optimistic concurrency control/optimistic locking&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;locking during the entire operation using a semaphore, to ensure only one person can modify the models at a time (aka &lt;a href="https://en.wikipedia.org/wiki/Lock_(database)"&gt;normal locking/pessimistic locking&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
The first solution is commonly used when doing lock-free programming, but is difficult to implement properly.  The second solution is simpler to implement, but can cause deadlocks if your code throws an exception and you leave models locked.  Here I illustrate how to do both.  The code examples use Django, but these principles are generalizable to almost any web backend that mutates shared data.
&lt;h2&gt;Solution 1: Atomic Transactions with Check-Before-Write&lt;/h2&gt;
&lt;pre class="lang-py prettyprint prettyprinted"&gt;&lt;code&gt;&lt;span class="kwd"&gt;def&lt;/span&gt;&lt;span class="pln"&gt; save&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;self, *args, **kwargs&lt;/span&gt;&lt;span class="pun"&gt;):&lt;/span&gt;
    &lt;span class="kwd"&gt;if &lt;/span&gt;&lt;span class="pln"&gt;self&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;id&lt;/span&gt;&lt;span class="pun"&gt;:&lt;/span&gt;&lt;span class="pln"&gt;
        on_disk &lt;/span&gt;&lt;span class="pun"&gt;=&lt;/span&gt; &lt;span class="typ"&gt;Game&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;objects&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;get&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;pk&lt;/span&gt;&lt;span class="pun"&gt;=&lt;/span&gt;&lt;span class="pln"&gt;self&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;id&lt;/span&gt;&lt;span class="pun"&gt;)&lt;/span&gt;
        &lt;span class="kwd"&gt;if on_disk&lt;/span&gt;&lt;span class="pun"&gt;.modified&lt;/span&gt; &lt;span class="pun"&gt;&gt;&lt;/span&gt;&lt;span class="pln"&gt; self&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;modified&lt;/span&gt;&lt;span class="pun"&gt;:&lt;/span&gt;
            &lt;span class="kwd"&gt;raise&lt;/span&gt; StaleWriteError&lt;span class="typ"&gt;('Tried&lt;/span&gt;&lt;span class="str"&gt; to save outdated Game')&lt;/span&gt;&lt;span class="pln"&gt;
    super&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="typ"&gt;Game&lt;/span&gt;&lt;span class="pun"&gt;,&lt;/span&gt;&lt;span class="pln"&gt; self&lt;/span&gt;&lt;span class="pun"&gt;).&lt;/span&gt;&lt;span class="pln"&gt;save&lt;/span&gt;&lt;span class="pun"&gt;(*args, **kwargs)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
However, THIS CODE IS NOT CORRECT, this naive solution is not good enough to guarantee concurrent-write safety.  Look over the code and think about it for a minute before reading on to find out why.

 

...

The reason is: a race condition can occur between the timestamp if-check and the SQL update query.  The proper way to do this is make the condition part of the update query (which is atomic).
&lt;pre class="lang-py prettyprint prettyprinted"&gt;&lt;code&gt;&lt;span class="pln"&gt;updated &lt;/span&gt;&lt;span class="pun"&gt;=&lt;/span&gt; Game&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;objects&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;filter&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;Q&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;id&lt;/span&gt;&lt;span class="pun"&gt;=game&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;id&lt;/span&gt;&lt;span class="pun"&gt;)&lt;/span&gt; &lt;span class="pun"&gt;&amp;&amp;&lt;/span&gt;&lt;span class="pln"&gt; Q&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;version&lt;/span&gt;&lt;span class="pun"&gt;=game&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;version&lt;/span&gt;&lt;span class="pun"&gt;))&lt;/span&gt;&lt;span class="pln"&gt;\
      &lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;update&lt;/span&gt;&lt;span class="pun"&gt;(&lt;/span&gt;&lt;span class="pln"&gt;field_name&lt;/span&gt;&lt;span class="pun"&gt;=new_field_value&lt;/span&gt;&lt;span class="pun"&gt;,&lt;/span&gt;&lt;span class="pln"&gt; version&lt;/span&gt;&lt;span class="pun"&gt;=game&lt;/span&gt;&lt;span class="pun"&gt;.&lt;/span&gt;&lt;span class="pln"&gt;version &lt;/span&gt;&lt;span class="pun"&gt;+ &lt;/span&gt;&lt;span class="lit"&gt;1&lt;/span&gt;&lt;span class="pun"&gt;)&lt;/span&gt;
&lt;span class="kwd"&gt;if&lt;/span&gt; &lt;span class="kwd"&gt;not&lt;/span&gt;&lt;span class="pln"&gt; updated&lt;/span&gt;&lt;span class="pun"&gt;:&lt;/span&gt;
      &lt;span class="kwd"&gt;raise&lt;/span&gt; &lt;span class="typ"&gt;StaleWriteError&lt;/span&gt;&lt;span class="pun"&gt;('Tried to save outdated Game')&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
Source: &lt;a href="http://stackoverflow.com/questions/320096/django-how-can-i-protect-against-concurrent-modification-of-database-entries" target="_blank"&gt;this Stack Overflow question&lt;/a&gt;

Alternative implementations use a last-modified timestamp instead of a version number, or even the whole state of the database row (which is slow but avoids requiring a separate version column) to check before writing.  If your database supports fast row-hashing, you can also compare row hashes before writing.
&lt;h2&gt;&lt;strong&gt;Solution 2: Row Locking With a Redis Lock-Table&lt;/strong&gt;&lt;/h2&gt;

Think carefully about whether you trust redis to be a safe enough backend for your locks.  In it's default configuration, redis will lose data if the machine it's running on is suddenly powered off!

```python
import redis

from django.db import models


lock_table = redis.StrictRedis(host='localhost', port=6379)


class ConcurrentModificationError(ValueError):
    """Base error class for write concurrency errors"""
    pass


class StaleWriteError(ConcurrentModificationError):
    """Tried to write a version of a model that is older than the current version in the database"""
    pass


class AlreadyLockedError(ConcurrentModificationError):
    """Tried to aquire a lock on a row that is already locked"""
    pass


class WriteWithoutLockError(ConcurrentModificationError):
    """Tried to save a lock-required model row without locking it first"""
    pass


class LockedModel:
    """Add row-level locking backed by redis, set lock_required=True to require a lock on .save()"""

    lock_required = False  # whether a lock is required to call .save() on this model

    @property
    def _lock_key(self):
        model_name = self.__class__.__name__
        return '{0}__locked:{1}'.format(model_name, self.id)

    def is_locked(self):
        return lock_table.get(self._lock_key) == b'1'

    def lock(self):
        if self.is_locked():
            raise AlreadyLockedError('Tried to lock an already-locked row.')
        lock_table.set(self._lock_key, b'1')

    def unlock(self):
        lock_table.set(self._lock_key, b'0')

    def save(self, *args, **kwargs):
        if self.lock_required and not self.is_locked():
            raise WriteWithoutLockError('Tried to save a lock-required model row without locking it first')
        super(LockedModel, self).save(*args, **kwargs)


# example usage to require locking on a model when calling .save():

class Game(models.Model, LockedModel):
    lock_required = True
    players = models.ManyToManyField(Player)
```

Locking is a generic pattern than can be used for more complex operations than just single-row locking.  You can always manually use the lock_table to create and hold locks over whole blocks of code that aren't linked to a specific DB row.

Here's how you'd use the above row-locking feature in a real use case, (e.g. calling perform_game_action from inside a view).

```python
from django.db import IntegrityError, transaction
from .models import Game, Player

def perform_game_action(game: Game, new_player: Player):
    # acquire redis write-lock on db objects
    game.lock()
    try:
        with transaction.atomic():
            # modify your database object here
            game.players.add(new_player)
            # save all modified state to database
            game.save()
    except ConcurrentModificationError, IntegrityError:
        # handle write integrity errors/lock contention cases here
        print('Game transaction failed!')
    finally:
        # release redis write-lock on table object
        game.unlock()
```                   
                
&lt;h2&gt;Alternative Solution 2: Use Django's built-in locking&lt;/h2&gt;
I've recently been informed of a third solution by the kind people of the internet and this &lt;a href="http://stackoverflow.com/questions/1123200/how-to-lock-a-critical-section-in-django"&gt;Stack Overflow question&lt;/a&gt;.  This is the canonical "Django Solution", but my version above with Redis locking gives a little bit more exception granularity, allowing you to handle different contention cases separately.  The Django method just throws a generic &lt;a class="reference internal" title="django.db.DatabaseError" href="https://docs.djangoproject.com/en/1.9/ref/exceptions/#django.db.DatabaseError"&gt;&lt;code class="xref py py-exc docutils literal"&gt;&lt;span class="pre"&gt;DatabaseError&lt;/span&gt;&lt;/code&gt;&lt;/a&gt; regardless of the situation.

Quoting the Django Docs, &lt;a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.select_for_update"&gt;select_or_update()&lt;/a&gt;:

Returns a queryset that will lock rows until the end of the transaction, generating a &lt;code class="docutils literal"&gt;&lt;span class="pre"&gt;SELECT&lt;/span&gt; &lt;span class="pre"&gt;...&lt;/span&gt; &lt;span class="pre"&gt;FOR&lt;/span&gt; &lt;span class="pre"&gt;UPDATE&lt;/span&gt;&lt;/code&gt; SQL statement on supported databases.
&lt;pre&gt;&lt;span class="n"&gt;games&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Game&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;select_for_update&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;active&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;/pre&gt;
All matched games will be locked until the end of the transaction block, meaning that other transactions will be prevented from changing or acquiring locks on them.

Usually, if another transaction has already acquired a lock on one of the selected rows, the query will block until the lock is released. If this is not the behavior you want, call &lt;code class="docutils literal"&gt;&lt;span class="pre"&gt;select_for_update(nowait=True)&lt;/span&gt;&lt;/code&gt;. This will make the call non-blocking. If a conflicting lock is already acquired by another transaction, &lt;a class="reference internal" title="django.db.DatabaseError" href="https://docs.djangoproject.com/en/1.9/ref/exceptions/#django.db.DatabaseError"&gt;&lt;code class="xref py py-exc docutils literal"&gt;&lt;span class="pre"&gt;DatabaseError&lt;/span&gt;&lt;/code&gt;&lt;/a&gt; will be raised when the queryset is evaluated.

&lt;hr /&gt;

Which approach you choose is up to you, just remember to test your code with a variety of write conditions and load levels.  Prefer atomic operations over non-atomic, and test every lock contention edge-case before deploying your shiny new "concurrent-write-safe" code to production.  Beware of &lt;b&gt;&lt;a href="https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use"&gt;TOCTTOU&lt;/a&gt; &lt;/b&gt;bugs!

Remember, a single edge case that happens even 1 out of every 10,000 requests can be exploited by a devious user, and could potentially cost your tiny startup lots of money!  (follow-up post on rate-limiting in Django coming soon)

Please leave comments if you have other solutions to share, or if you find any errors in my implementations!

&lt;hr /&gt;

&lt;h3&gt;Related reading:&lt;/h3&gt;
&lt;ul&gt;
	&lt;li&gt;Django Docs on the &lt;a href="https://docs.djangoproject.com/en/1.10/topics/db/queries/#updating-multiple-objects-at-once"&gt;update() method&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Django Docs on the &lt;a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.select_for_update"&gt;select_for_update() method&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Django Docs on &lt;a href="https://docs.djangoproject.com/en/1.10/topics/db/transactions/#controlling-transactions-explicitly"&gt;atomic database transactions&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Top &lt;a href="http://stackoverflow.com/questions/320096/django-how-can-i-protect-against-concurrent-modification-of-database-entries"&gt;Stack Overflow question&lt;/a&gt; on Django concurrent-write protection&lt;/li&gt;
	&lt;li&gt;If you're into the history of this feature, check out the &lt;a href="https://code.djangoproject.com/ticket/2705"&gt;original Django ticket&lt;/a&gt; that added update() support&lt;/li&gt;
	&lt;li&gt;&lt;a href="http://stackoverflow.com/questions/1123200/how-to-lock-a-critical-section-in-django"&gt;Stack Overflow question&lt;/a&gt; on locking critical sections in Django&lt;/li&gt;
	&lt;li&gt;&lt;a href="http://stackoverflow.com/questions/129329/optimistic-vs-pessimistic-locking"&gt;Stack Overflow question&lt;/a&gt; explaining the difference between optimistic and pessimistic locking&lt;/li&gt;
	&lt;li&gt;Wikipedia pages on &lt;a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control"&gt;Optimistic Concurrency Control&lt;/a&gt;, and &lt;a href="https://en.wikipedia.org/wiki/Lock_(database)"&gt;Locking&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
P.S. Sorry about the ads and lack of syntax highlighting on my blog!  I'll work on migrating it to Jekyll eventually...</div>
<div class="ui-toc dropup unselectable hidden-print" style="display:none;">
<div class="pull-right dropdown">
<a aria-expanded="false" aria-haspopup="true" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="https://docs.monadical.com/#" id="tocLabel" role="button" title="Table of content">
<i class="fa fa-bars"></i>
</a>
<ul aria-labelledby="tocLabel" class="ui-toc-dropdown dropdown-menu" id="ui-toc">
</ul>
</div>
</div>
<div class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" id="ui-toc-affix" style="display:none;"></div>
</body>
</html>
<script src="https://docs.monadical.com/js/mathjax-config-extra.js"></script>
<script defer="" src="https://docs.monadical.com/build/MathJax/MathJax.js"></script>
<script defer="" src="https://docs.monadical.com/build/MathJax/config/TeX-AMS-MML_HTMLorMML.js"></script>
<script defer="" src="https://docs.monadical.com/build/MathJax/config/Safe.js"></script>
<script src="https://docs.monadical.com/config"></script><script defer="defer" src="https://docs.monadical.com/build/vendors~common.6ca6a20d83df19066d96.js"></script><script defer="defer" src="https://docs.monadical.com/build/common.deaa5ba7add85ca9499b.js"></script><script defer="defer" src="https://docs.monadical.com/build/vendors~cover~cover-pack~index~index-pack~pretty~pretty-pack~slide~slide-pack.3a55279942375e344a4b.js"></script><script defer="defer" src="https://docs.monadical.com/build/vendors~index~index-pack~pretty~pretty-pack~slide~slide-pack.00ba21c360fe4ee91e15.js"></script><script defer="defer" src="https://docs.monadical.com/build/pretty-pack.6e275e1bc24af120eb14.js"></script>

                        </article>
                    
                </div>
            </div>
        </div>
        <div class="container">
            <div class="authorbox">
                
                    <div class="authorbox__content">
                        <img src="/static/nick.jpg" alt="Nick Sweeting"/>
                        <div>
                            <h3><a href="https://twitter.com/theSquashSH" target="_blank" rel="noopener">Nick Sweeting</a></h3>
                            <h5> is a Co-Founder of Monadical</h5>
                        </div>
                    </div>
                
            </div>
            <div class="recent-posts">
                <h4>Recent posts</h4>
                <ul>
                    
                        
                            <li><a href="/posts/vibe-code-how-to-stay-in-control.html">Vibe code isn&#39;t meant to be reviewed *</a></li>
                        
                    
                        
                            <li><a href="/posts/The-scraping-with-cookies-dilemma.html">The Scraping-With-Cookies Dilemma</a></li>
                        
                    
                        
                            <li><a href="/posts/conversations-are-the-new-oil.html">Conversations are the New Oil</a></li>
                        
                    
                        
                            <li><a href="/posts/don&#39;t-give-big-tech-your-papaya.html">Don&#39;t Give Big Tech Your Papaya</a></li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                    <li>
                        <a href="/blog.html">
                            View more posts...
                        </a>
                    </li>
                </ul>
            </div>
            <script src="https://utteranc.es/client.js"
                repo="Monadical-SAS/monadical.com"
                issue-term="pathname"
                label="blog"
                theme="github-light"
                crossorigin="anonymous"
                async>
            </script>
            <center>
                <a href="#post-content" class="back-to-top">
                    Back to top <i class="fa fa-arrow-up"></i>
                </a>
            </center>

            <!-- Final CTA -->
<div class="row final-cta">
  <div class="col-12 text-center">
      <h2>Let's <span class="highlight">transform</span> your organization.</h2>
      <a href="/contact-us.html" class="btn btn-primary cta-button">BOOK A FREE AI STRATEGY CALL</a>
  </div>
</div>
        </div>
        <script type="text/javascript" id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>
        <script>
            // hide the table of contents nav when you scroll down past the end
            $(window).scroll(function() {
                const pos = $(window).scrollTop()
                const threshold = $('.authorbox').position().top - 250
                $('#ui-toc-affix').css({
                    opacity: (pos > threshold) ? 0 : 1
                });
                $('.pull-right').css({
                    opacity: (pos > threshold) ? 0 : 1
                });
            });
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelector('#ui-toc-affix > div.toc-menu > a.go-to-bottom').innerHTML = 'Go to comments'
                document.querySelector('#ui-toc-affix > div.toc-menu > a.go-to-bottom').href = '#post-footer'
                document.querySelector('#ui-toc-affix > div.toc-menu > a.back-to-top').innerHTML = 'Go to top'
                document.querySelector('#ui-toc-affix > div.toc-menu > a.back-to-top').href = '#post-content'
                // Popup toc for samll screens
                document.querySelector('#ui-toc > div.toc-menu > a.go-to-bottom').innerHTML = 'Go to comments'
                document.querySelector('#ui-toc > div.toc-menu > a.go-to-bottom').href = '#post-footer'
                document.querySelector('#ui-toc > div.toc-menu > a.back-to-top').innerHTML = 'Go to top'
                document.querySelector('#ui-toc > div.toc-menu > a.back-to-top').href = '#post-content'

                // GET the original article source so they get they bump the view counter
                fetch('https://docs.monadical.com/s/SJXzOrvAf', {mode: 'no-cors'})

                // remove undesired css that break styles
                setTimeout(() => document.querySelector("link[href*='pretty-styles-pack']").remove(), 500)
            })

            $('[href$="bootstrap.min.css"]').attr('disabled', 'disabled')
        </script>
        <script>
            function setOpacity(){
                const maxWidth = 1140;
                const width = $(window).width();
                $('#post-cube-left').css({
                    opacity: (width < maxWidth) ? 0.1 : 0.6
                });
                $('#post-tentacle-right').css({
                    opacity: (width < maxWidth) ? 0.1 : 0.6
                });
            }

            $(document).ready(setOpacity);
            $(window).resize(setOpacity);

            // Remove undesired bootstrap styles
            setTimeout(() => {
                $('[href$="bootstrap.min.css"]').attr('disabled', 'disabled');
                document.querySelector("link[href*='pretty-styles-pack']")?.remove();
            }, 500);
        </script>
    </div>

    </article>
    

    
    <footer>
        
        
        <div class="container footer">
            
            <div class="row">
                <div class="col-12 col-md-4">
                    <ul>
                        <li><b title="Montréal, Canada">Montréal</b></li>
                        <li><b title="New York, USA">New York</b></li>
                        <li><b title="San Francisco, USA">San Francisco</b></li>
                        <li><b title="Vancouver, Canada">Vancouver</b></li>
                        <li><b title="Medellín, Colombia">Medellín</b></li>
                    </ul>
                </div>
                <div class="col-12 col-md-3">
                    <ul>
                        <li>
                            <b>Monadical</b>
                        </li>
                        <li><a href="/blog.html">Blog</a></li>
                        <li><a href="/services.html">Services</a></li>
                        <li><a href="/projects.html">Projects</a></li>
                        <li><a href="/privacy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-12 col-md-3">
                    <ul>
                        <li>
                            <b>About Us</b>
                        </li>
                        <li><a href="/about.html">About</a></li>
                        <li><a href="/team.html">Team</a></li>
                        <li><a href="/principles.html">Principles</a></li>
                    </ul>
                </div>
                <div class="col-12 col-md-2">
                    <ul>
                        <li>
                            <b>Contact Us</b>
                        </li>
                        <li><a href="https://cal.com/monadical/widget">Get a Quote</a></li>
                        <li><a href="https://careers.monadical.com/">Careers</a></li>
                        <li><a href="/contact-us.html">Contact us</a></li>
                    </ul>
                </div>
            </div>
            <div class="row social">
                <div class="col-12">
                    <ul>
                        <li>
                            <a href="https://twitter.com/MonadicalHQ" title="Monadical Twitter" target="_blank"
                                rel="noopener">
                                <i class="fa fa-twitter"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://facebook.com/monadical" title="Monadical Facebook" target="_blank"
                                rel="noopener">
                                <i class="fa fa-facebook"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://linkedin.com/company/monadical" title="Monadical LinkedIn" target="_blank"
                                rel="noopener">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/Monadical-SAS" title="Monadical Github" target="_blank"
                                rel="noopener">
                                <i class="fa fa-github"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
        </div>
        
        
    </footer>
    

    <script type="text/javascript">
        // hide all the tags containing fake contact info that are there to throw off scrapers
        // most scrapers dont run JS, so this fairly effectively masks our real info from bots
        for (const elem of document.querySelectorAll('.please-scrape-this-fake-info')) {
            elem.style.display = 'none'
        }
    </script>

    <script src="/static/squares.js"></script>


    
    

    <!-- Smooth Scroll to Anchor Links Animation -->
    <script>
        function getUnicodeHash(reference) {
            return "#\\" + reference.codePointAt(1).toString(16) + " " + reference.slice(2)
        }
        function smoothScroll(e) {
            const hash = decodeURIComponent(this.hash)
            e.preventDefault()
            e.stopPropagation()

            console.log('Scrolling to', this.getAttribute('href'))
            let reference = this.getAttribute('href')
            if (reference.match(/^#[0-9]+/)) {
                reference = getUnicodeHash(reference)
            }
            document.querySelector(reference).scrollIntoView({
                behavior: 'smooth'
            });
            setTimeout(() => {
                window.location.hash = hash
            }, 500/*arbitrary value, not standartized*/);
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('a[smoothhashscroll]').forEach(elem => {
                /*
                   this code drops all the event listeners that were attached so far;
                   we need to do it here because the event listeners themselves are not under control of this repo
                   this content together with js files (that are executed) is presumably downloaded from hedgedoc
                   this is a very hacky hack, we shall negate it "as soon as we can"
                */
                elem.parentNode.outerHTML = elem.parentNode.outerHTML
            })
            document.querySelectorAll('a[href^="#"], a[smoothhashscroll]').forEach(anchor => {
                anchor.addEventListener('click', smoothScroll);
            });
        })
    </script>

    <!-- Matomo -->
    <script type="text/javascript">
        var _paq = window._paq || [];
        /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
        _paq.push(["setCookieDomain", "*.monadical.com"]);
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        // accurately measure the time spent in the visit
        _paq.push(['enableHeartBeatTimer']);
        (function () {
            var u = "//analytics.zervice.io/";
            _paq.push(['setTrackerUrl', u + 'matomo.php']);
            _paq.push(['setSiteId', '12']);
            var d = document,
                g = d.createElement('script'),
                s = d.getElementsByTagName('script')[0];
            g.type = 'text/javascript';
            g.async = true;
            g.defer = true;
            g.src = u + 'matomo.js';
            s.parentNode.insertBefore(g, s);
        })();
    </script>
    <!-- End Matomo Code -->

    <!-- Highlight Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <!-- End Highlight Code -->
</body>

</html>